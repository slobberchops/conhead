name: Release Python package

on:
  push:
    tags:
      - 'v*'

jobs:
  pre-commit:
    runs-on: ubuntu-20.04
    name: Builds and publishes release.
    steps:

    - uses: actions/checkout@v3

    - uses: actions/setup-python@v3
      with:
        python-version: "3.9"
        architecture: x64

    - name: Install Poetry
      run: pipx install --python python${{ matrix.python-version }} poetry
    - name: Extract version from poetry
      run: mkdir dist && poetry install --dry-run | grep -o 'conhead \(.*\)' | grep -o '[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' > dist/VERSION
    - name: Build sdist
      run: poetry build -f sdist

    - run: echo RELEASE_VERSION=$(cat dist/VERSION)
    - run: python -m venv dist/test-installation
    - run: dist/test-installation/bin/pip install
